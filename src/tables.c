/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018, 2019 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int piece_value[N_PIECES] = { 100, 310, 330, 500, 1000, 20000 };
const int piece_phase[N_PIECES] = { 0, 6, 6, 13, 28, 0 };

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   14,  16,  -4,  23,  36,  34,  -5, -27,
  -14,  -2,  20,  19,  67,  42,  10,  -8,
  -16,  -3, -12,  -2,  -2,  -3,  -4, -16,
  -22, -27,  -9, -18, -10, -10, -22, -41,
  -31, -25, -30, -36, -23, -27, -11, -40,
  -31, -18, -24, -24, -24,  -4,  13, -27,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -136, -88, -46, -25,  19,-119,-112, -84,
    6,  19,  44,  66,  40,  68,  34,  31,
   17,  38,  53,  60,  82,  90,  53,  33,
   51,  58,  63,  75,  65,  74,  60,  70,
   54,  47,  65,  64,  75,  73,  76,  65,
   30,  43,  41,  50,  55,  57,  60,  39,
   19,  26,  34,  43,  50,  41,  44,  36,
   -5,  34,  18,  37,  45,  31,  34,  10
  }, {
   41,   2, -65, -64, -57, -84, -19,   7,
   -1,  10,  14,   0,  20,   8,  -8, -24,
   15,  19,  27,  45,  56,  57,  28,  33,
   20,  49,  34,  52,  47,  49,  57,  21,
   31,  33,  41,  54,  62,  47,  46,  57,
   33,  48,  38,  40,  40,  47,  49,  38,
   44,  39,  45,  27,  35,  46,  57,  40,
   32,  42,  29,  18,  29,  21,  17,  41
  }, {
   15,  -2, -17,  12,   2, -30,  -1,  17,
    7, -11,  12,  31,   1,  11, -27,  10,
   -3,  18,   6,  19,  40,  36,  22,  -7,
   -6,   2,  16,  15,  30,  31,   7,   4,
  -11, -11,  -3,   9,  11,  10,  21, -14,
  -15,  -1,  -4,   5,   5,   6,  13, -12,
  -10,  -7,   1,   8,  12,   5,   2, -46,
    5,   9,  13,  21,  22,  20,  -6,   3
  }, {
  -30,  -4,  23,  17,  12,  29,  29,  15,
  -15,  -4,   6,  -7, -54, -14, -24,   8,
    9,  23,  25,  30,  23,  23,   7,  -2,
    2,  23,  23,  12,  34,  25,  32,  15,
   29,  19,  21,  14,  36,  26,  41,  28,
   15,  31,  19,  21,  24,  27,  42,  24,
   14,  24,  33,  28,  28,  41,  42,  14,
   21,  15,  18,  26,  15,   8,  -3,   8
  }, {
    6,  19,  74, -24, -31, -54,  79,  94,
   13,  83,  41,  50,  28,  60, -25, -51,
  -22,  54, 141,  59,  79, 163,  69, -38,
  -50,  31,  69,  42,  50,  68,  25,-162,
  -57,  45,  33,  15,  11,   0,   3,-116,
  -69,  -2,  -4,  -3, -11,  -9,   6, -47,
  -13,  -6,  -5, -42, -33, -13,  16,   9,
   -8,   9,   2, -51,   2, -34,  25,   7
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    7,  16,  27,  31,  37,  27,  32,  13,
    8,   6,   2,   5,  19,   3,  12,   7,
    2,  -6,  -8, -16, -12,  -3,  -2,  -4,
   -7,  -4, -19, -23, -19, -13,  -8, -15,
  -12, -10, -17, -12, -14, -10, -16, -20,
  -12,  -8, -10, -11,  -3,  -6, -10, -22,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -47, -16,  -8, -18, -25, -27, -22, -70,
  -15,  -3, -17, -10,   0,  -8,  -7, -36,
   -5,  -1,  16,  15,  10,   4,   0, -21,
   -6,  -1,  17,  20,  14,  12,  -1, -14,
   -6,   6,  17,  18,  18,  17,   0,  -1,
  -14,  -6,   6,  14,  11,  -1, -12, -10,
  -26, -10, -14,   1,  -5, -17,  -6, -12,
  -23, -24, -15,  -6, -15, -18, -19, -40
  }, {
   -7,  -7, -10,  -4,  -9,   4,  -7, -18,
   -5,   1,  -2,  -2,  -2,  -7,  -6, -15,
   -7,   2,   4,   1,   4,   7,  -3, -11,
   -5,  -1,   2,  13,  11,   3,  -6, -14,
   -4,  -3,   8,  13,  10,   6,  -8, -18,
  -12,  -2,   1,   4,   3,   4,  -5,  -6,
  -10, -14, -13,  -4,  -7, -11, -15, -29,
  -14, -18, -10, -11, -12,  -4, -21, -22
  }, {
   32,  39,  40,  37,  38,  39,  38,  38,
   29,  33,  34,  32,  28,  26,  32,  28,
   29,  28,  30,  27,  22,  27,  17,  23,
   31,  32,  30,  29,  23,  21,  23,  22,
   28,  31,  30,  26,  25,  21,  18,  20,
   25,  26,  28,  20,  20,  14,  11,  17,
   14,  20,  24,  19,  14,   9,   8,  14,
   22,  18,  23,  14,  17,  11,  19,  16
  }, {
   34,  41,  34,  34,  21,  39,  20,  23,
   51,  45,  56,  60,  68,  62,  36,  30,
   37,  45,  35,  53,  49,  23,  15,   2,
   59,  52,  59,  65,  53,  35,  41,  31,
   22,  49,  52,  62,  42,  56,  48,  42,
   24,  24,  45,  36,  45,  50,  37,  15,
   20,  13,   2,  19,  23,  -7, -13,  -3,
    4,   2,   1,  -8,  14,  -3,   6,  14
  }, {
  -41, -25,  -4,   2,  -1, -19, -37, -32,
  -11,  19,  12,  11,  18,  20,  31, -11,
    2,  14,  27,  25,  26,  32,  23,   7,
   -1,  21,  22,  21,  18,  21,  21,   6,
   -3,  14,  19,  17,  16,  16,   9,  -2,
   -6,  10,  13,  12,  11,  15,   6,  -8,
  -21,  -1,   9,   7,   6,  11,   3, -17,
  -48, -20,  -6,  -4, -18,  -1, -15, -41
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,  20,  22,  10,   8,  22,  12,   3,
   11,  21,  -5,   4,   7,   4,   7,  13,
    2,  -3,  -4,   3,   1,  -5,  -9,   7,
    4, -16,   6,  -3, -10,   1,  -9,  -3,
   36,  84,  53, -18, -34,  -9,  23,  -4,
   42,  47,  95,  37,  73,  36,   5, -29,
  -32, -34, -15,  -6,  -5, -11, -22, -29
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
  -37, -58, -15, -30, -30,  -7, -32,  -8,
   28,  -4, -12, -14,   0,  -1,   6,  25,
   21,   2,  -3,   1,   9,  -5,  -5,   8,
   16,  34,   0,   4,  15,  -8,   8,   9,
   11,  27,   2,   2,   3,   6,   0,   7,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
   57,  22, -26,  17, -54, -45,  20,  83,
  -20,-124, -82, -11, -58, -94, -79, -28,
  -20,  -1, -34, -22, -16, -18,  -6, -16,
   11,  16, -16, -10,  -9,  -7,   4,  -5,
    9,  45,   6,   6,   8,   3,  27,  21,
   28,  30,   3,   4,  -3,  11,  11,  14,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      6,  15, -17,  39,  13,  32, -21,  30,
      2,   0,   5,  11,  27,  33,  17,  15,
     -3,  15,   9,   9,  12,  12,  23,  16,
      6,  10,  16,  16,  17,   8,  26,  15,
      9,  -1,   3,  -5,   2,  -4,   8,   1,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     28,  27,  45,  32,  24,  36,  37,   8,
      7,  13,   0,   3,   9,  -1,   5,  -6,
      2,   2,   6,  13,   8,   4,  -1,   2,
     -1,   5,  11,   7,  12,   5,   1,  -2,
     -4,   1,   1,   1,   5,  -6,   1, -20,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
    146, 125, 158, 172, 189, 150,  63,  35,
     33,  39,  75,  64,  50,  52,  94,  46,
     44,  40,  45,  40,  53,  32,  35,  41,
     23,  31,  21,  31,  32,  24,  32,  30,
     22,  30,  24,  29,  31,  19,  33,  25,
     18,   5,   6,  20,  17,  -2,   7,   5,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     56,  91,  48,  91,  78,  96,  66,  64,
     76,  64,  66,  56,  55,  57,  34,  57,
     31,  38,  37,  34,  33,  30,  28,  27,
     12,  10,  18,  25,  20,  12,   9,  12,
     -2,   4,   9,   9,   9,   2,   1,  -2,
    -16,  -6,  -5,  -4,  -3,  -8,   0, -20,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

const int passer_bonus[N_PHASES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
  110,  95,  92,  94, 100,  76,  90, 120,
   65,  37,  23,  37,  -3,  28, -10,  18,
   32,  11,  14,  12,  10,   5,  23,   7,
   24,   3, -17,  -3, -13,  -7, -21,   8,
   -1,  -3, -14,  -9, -18, -15, -36,  10,
   -4,  -6,  -7,   1,   8, -40, -31,   0,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
  103, 110, 111, 107, 107, 114, 114, 115,
   60,  69,  73,  70,  63,  81,  84,  77,
   38,  41,  35,  38,  37,  38,  44,  42,
   27,  24,  25,  23,  22,  23,  33,  28,
    7,   4,   6,   1,   4,   1,  13,   3,
    3,   9,  -2,  -2,  -7,  -3,   6,   1,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int distance_bonus[2][N_RANK] = {
  { 0, 2, 3, 7, 18, 38, 46, 0 },
  { 0, 3, 3, 7, 11, 18, 21, 0 },
};

const int doubled_penalty[N_PHASES] = {8, 24};
const int backward_penalty[N_PHASES] = {-2, 2};
const int isolated_penalty[N_PHASES] = {4, 3};

const int mobility[N_PHASES][N_PIECES - 1][32] = {
  {
    {},
    { -2, 19, 31, 40, 49, 55, 61, 66, 71 },
    {  1, 14, 28, 31, 40, 46, 48, 47, 47, 48, 56, 65, 71, 100 },
    { -68, 5, 19, 22, 26, 25, 28, 32, 34, 36, 34, 37, 38, 46, 43 },
    { -169, 11, 9, 12, 13, 12, 16, 16, 21, 21, 22, 21, 23, 21,
        19, 20, 20, 12, 11, 15, 13, 18, 37, -7, 27, 22, -1, 13 },
  }, {
    {},
    { -67, -15, 7, 15, 20, 27, 24, 20, 6 },
    { -37, -10, -3, 9, 16, 23, 26, 27, 30, 26, 26, 16, 23, 6 },
    { -26, 6, 36, 43, 48, 55, 58, 59, 61, 66, 67, 68, 69, 67, 64 },
    { -13, -24, -31, 15, 16, 41, 50, 65, 59, 76, 87, 95, 95, 103,
      111, 110, 104, 111, 105, 96, 86, 74, 54, 62, 59, 58, 68, 74 },
  }
};

const int threats[N_PHASES][N_PIECES - 2][8] = {
  {
    {},
    { -2, -5, 26, 58, 28 },
    {  5, 23,  6, 46, 38 },
    {  3, 21, 21,  6, 29 },
  }, {
    {},
    { 16,  3, 32, 18,  2 },
    { 12, 34, 21, 22, 35 },
    { 16, 24, 33, 10, 19 },
  }
};

const int threat_king[N_PHASES] = {16, 28};
const int threat_protected_pawn[N_PHASES] = {55, 45};
const int threat_protected_pawn_push[N_PHASES] = {14, 13};
const int threats_on_queen[N_PIECES][N_PHASES] = {
  {}, {16, -9}, {20, 17}, {21, 6}, {}, {}
};

const int rook_file_bonus[N_PHASES][2] = { {13, 27}, {2, 5} };
const int bishop_pair[N_PHASES] = {40, 42};
const int pawn_mobility[N_PHASES] = {1, 7};
const int initiative[4] = {4, 66, 71, 89};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
